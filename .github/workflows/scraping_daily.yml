name: Daily Selenium Scraping

on:
  schedule:
    # Ejecutar todos los dรญas a las 10:20 UTC (7:20 AM Argentina)
    - cron: '20 10 * * *'
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  scraping:
    runs-on: ubuntu-latest

    steps:
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 1: Clonar repositorio
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ฆ Checkout repository
      uses: actions/checkout@v3

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 2: Configurar Python
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 3: Instalar dependencias
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager pandas supabase python-dotenv

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 4: Ejecutar scraping (actualiza sismos.csv)
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Run Selenium scraper
      run: |
        echo "Iniciando scraping de INPRES..."
        python inpres_sismos/inpres_sismos/selenium/actualizar_sismos.py || {
          echo "โ Error en scraping"
          exit 1
        }
        echo "โ Scraping completado"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 5: Actualizar base de datos SQLite
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐พ Update SQLite database
      run: |
        echo "Actualizando base de datos SQLite..."
        python inpres_sismos/inpres_sismos/db_scripts/actualizar_database.py || {
          echo "โ๏ธ  Advertencia: Error al actualizar SQLite, pero continuando..."
        }
        echo "โ SQLite actualizado"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 6: Sincronizar con Supabase
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: โ๏ธ  Sync with Supabase
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
          echo "Sincronizando con Supabase..."
          python inpres_sismos/inpres_sismos/db_scripts/actualizar_supabase.py || {
            echo "โ Error al sincronizar con Supabase"
            exit 1
          }
          echo "โ Supabase sincronizado"
        else
          echo "โ๏ธ  Supabase secrets no configurados, saltando sincronizaciรณn"
          echo "   Para configurar, ve a: Settings โ Secrets and variables โ Actions"
          echo "   Agrega: SUPABASE_URL y SUPABASE_SERVICE_ROLE_KEY"
        fi

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 7: Configurar Git y agregar cambios
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Configure Git and add changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Verificar si hay cambios
        if [[ -n $(git status -s) ]]; then
          echo "๐ Cambios detectados:"
          git status -s
          
          # Agregar archivos especรญficos
          git add data/sismos.csv || echo "โ๏ธ  sismos.csv no encontrado"
          git add data/sismos.db || echo "โ๏ธ  sismos.db no encontrado"
          
          # Commit solo si hay cambios staged
          if [[ -n $(git diff --cached) ]]; then
            FECHA=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "๐ค Actualizaciรณn automรกtica de sismos - $FECHA"
            echo "โ Commit creado"
          else
            echo "โน๏ธ  No hay cambios para commitear"
          fi
        else
          echo "โน๏ธ  No hay cambios en el repositorio"
        fi

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 8: Push de cambios al repositorio
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Push changes to repository
      run: |
        if [[ -n $(git log origin/main..HEAD) ]]; then
          echo "๐ค Enviando cambios al repositorio..."
          git push || {
            echo "โ Error al hacer push"
            exit 1
          }
          echo "โ Push completado exitosamente"
        else
          echo "โน๏ธ  No hay commits nuevos para enviar"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # PASO 9: Resumen de ejecuciรณn
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Summary
      if: always()
      run: |
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "           RESUMEN DE EJECUCIรN"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ Fecha: $(date -u +"%Y-%m-%d %H:%M UTC")"
        echo "๐ Archivos actualizados:"
        ls -lh data/ 2>/dev/null || echo "   โ๏ธ  Directorio data/ no encontrado"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"